<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>Stellar Wallets Kit dev testing</title>

  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #fafafa;
    }

    header {
      background-color: #fff;
      width: 100%;
      display: flex;
      border-bottom: solid 1px #ccc;
      padding: 0.5rem 1rem;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-logo {
      display: flex;
      align-items: center;
    }

    .logo {
      height: 32px;
      width: auto;
      max-width: 200px;
    }

    .header-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .header-controls {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    #networkSelectorWrapper {
      transition: all 0.3s ease-in-out;
      opacity: 0;
      transform: translateX(10px);
    }

    #networkSelectorWrapper.show {
      opacity: 1;
      transform: translateX(0);
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        padding: 1rem;
        gap: 0.75rem;
      }

      .header-controls {
        width: 100%;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .logo {
        height: 28px;
        max-width: 150px;
      }

      .header-title {
        font-size: 1rem;
      }

      #networkSelectorWrapper {
        order: 1; /* Show network selector above button on mobile */
      }
    }

    @media (max-width: 480px) {
      header {
        padding: 0.75rem;
      }

      .header-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }

      .logo {
        height: 24px;
        max-width: 120px;
      }

      .header-title {
        font-size: 0.9rem;
      }
    }

    main {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Responsive improvements for main content */
    @media (max-width: 768px) {
      main {
        padding: 0.75rem;
      }
    }

    @media (max-width: 480px) {
      main {
        padding: 0.5rem;
      }
    }

    input, textarea, button {
      padding: 0.5rem 1rem;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    /* Responsive form elements */
    @media (max-width: 768px) {
      input, textarea, button {
        padding: 0.75rem;
        font-size: 16px; /* Prevents zoom on iOS */
      }
    }

    @media (max-width: 480px) {
      input, textarea, button {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>

<header>
  <!-- <div id='reviewTransactionWrapper'></div> -->
     <div class="header-logo">
       <p>LumenKit</p>
     </div>
   <div class="header-controls">
    <div id='networkSelectorWrapper' style="display: none;"></div>
    <div id='reviewTransactionWrapper'></div>
    <div id='buttonWrapper'></div>
   </div>
  
</header>

<main>

<script type='module'>
  import { Buffer } from 'buffer';
  window.Buffer = Buffer;
  window.global = window;
</script>

<script type='module'>
  import {
    StellarWalletsKit,
    StellarReviewTransactionModal,
    StellarReviewTransactionButton,
    StellarNetworkSelectorButton,
    WalletNetwork,
    allowAllModules,
    XBULL_ID
  } from './build/index.mjs';
  import { setNetwork } from './build/index.mjs';
  import { WalletConnectModule, WalletConnectAllowedMethods } from './build/modules/walletconnect.module.mjs'
  import { LedgerModule } from './build/modules/ledger.module.mjs'
  import { TrezorModule } from './build/modules/trezor.module.mjs';

// Custom element is automatically registered through the build system

  // Always start with testnet
  let currentNetwork = WalletNetwork.TESTNET;
  let currentHorizonUrl = 'https://horizon-testnet.stellar.org';
  let currentNetworkPassphrase = 'Test SDF Network ; September 2015';
  
  console.log('🌐 Initializing with Testnet network');
  console.log('📍 Horizon URL:', currentHorizonUrl);
  console.log('🔑 Network Passphrase:', currentNetworkPassphrase);

  const kit = new StellarWalletsKit({
    network: currentNetwork,
    modules: [
      ...allowAllModules(),
      // ...allowAllModules({ filterBy: module => module.productId === XBULL_ID }),
      new LedgerModule(),
      new TrezorModule({
        appName: 'Stellar Wallets Kit',
        appUrl: 'http://localhost:5173',
        email: 'test@localhost.com'
      }),
      new WalletConnectModule({
        url: 'https://stellarwalletskit.dev/',
        projectId: '4e0b84f6ba6bedf7c7f041d919a9f039',
        method: WalletConnectAllowedMethods.SIGN,
        description: `This is a development ID, DO NOT sign transactions that come from this request if you are not a developer testing.`,
        name: 'StellarWalletsKit',
        icons: [],
        network: currentNetwork,
      }),
    ],
  });

  function createDefaultButton() {
    kit.createButton({
      container: document.querySelector('#buttonWrapper'),
      onConnect: ({ address }) => {
        console.log('Address requested: ', address);
        document.querySelector('#publicKey').setAttribute('value', address);
        
        // Show network selector when connected
        const networkSelector = document.querySelector('#networkSelectorWrapper');
        if (networkSelector) {
          networkSelector.style.display = 'block';
          setTimeout(() => {
            networkSelector.classList.add('show');
          }, 10);
        }
      },
      onDisconnect: () => {
        console.log('Disconnected from the button');
        
        // Hide network selector when disconnected
        const networkSelector = document.querySelector('#networkSelectorWrapper');
        if (networkSelector) {
          networkSelector.classList.remove('show');
          setTimeout(() => {
            networkSelector.style.display = 'none';
          }, 300);
        }
      },
      buttonText: 'Connect',
      horizonUrl: currentHorizonUrl
    })
  }

  // Network change notification function
  function showNetworkChangeNotification(networkName) {
    // Create a simple notification
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      font-family: 'Open Sans', sans-serif;
      font-size: 14px;
      font-weight: 500;
    `;
    notification.textContent = `🌐 Switched to ${networkName}`;
    document.body.appendChild(notification);
    
    // Remove notification after 3 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 3000);
  }

  // Ensure testnet is always the default
  function ensureTestnetDefault() {
    // Force kit to use testnet
    setNetwork(WalletNetwork.TESTNET);
    console.log('🔄 Forced kit to use Testnet network');
  }

  // Theme detection and logo switching
  function updateLogoForTheme() {
    const logo = document.querySelector('.logo');
    if (!logo) return;
    
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const isDarkTheme = document.body.classList.contains('dark-theme') || prefersDark;
    
    logo.src = isDarkTheme ? 'public/logo-white.svg' : 'public/logo-black.svg';
  }

  // Listen for theme changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateLogoForTheme);

  createDefaultButton();
  createNetworkSelectorButton();
  ensureTestnetDefault();
  updateLogoForTheme();

  // Review Transaction Modal functionality
  let reviewModal = null;

  // Create Network Selector Button
  function createNetworkSelectorButton() {
    console.log('Creating Network Selector Button...');
    const networkButton = document.createElement('stellar-network-selector-button');
    networkButton.setAttribute('networkName', 'Stellar Testnet');
    networkButton.setAttribute('selectedNetwork', 'testnet');
    
    const wrapper = document.querySelector('#networkSelectorWrapper');
    console.log('Wrapper found:', wrapper);
    
    if (wrapper) {
      wrapper.appendChild(networkButton);
      console.log('Network Selector Button added to DOM');
      
      // Force initialization with testnet
      setTimeout(() => {
        networkButton.selectedNetwork = 'testnet';
        networkButton.networkName = 'Stellar Testnet';
        console.log('Forced initialization with testnet');
      }, 100);
    } else {
      console.error('Network Selector Wrapper not found!');
    }
    
    networkButton.addEventListener('click', function() {
      console.log('Network Selector button clicked');
    });
    
    networkButton.addEventListener('network-changed', function(event) {
      console.log('Network changed:', event.detail);
      
      // Update current network variables
      currentNetwork = event.detail.networkId === 'mainnet' ? WalletNetwork.MAINNET : 
                      event.detail.networkId === 'testnet' ? WalletNetwork.TESTNET : 
                      WalletNetwork.FUTURENET;
      currentHorizonUrl = event.detail.horizonUrl;
      currentNetworkPassphrase = event.detail.networkPassphrase;
      
      // Update the kit's network
      setNetwork(currentNetwork);
      
      // Format network name to always start with "Stellar"
      const networkName = event.detail.networkName.startsWith('Stellar') 
        ? event.detail.networkName 
        : `Stellar ${event.detail.networkName}`;
      
      // Show notification to user
      console.log(`🌐 Switched to ${networkName}`);
      console.log(`📍 Horizon URL: ${currentHorizonUrl}`);
      console.log(`🔑 Network Passphrase: ${currentNetworkPassphrase}`);
      
      // You can also show a toast notification or update UI here
      showNetworkChangeNotification(networkName);
    });
  }

  // Create Review Transaction Button
  function createReviewTransactionButton() {
    const reviewButton = document.createElement('stellar-review-transaction-button');
    reviewButton.setAttribute('buttonText', 'Review Transaction');
    document.querySelector('#reviewTransactionWrapper').appendChild(reviewButton);
    
    reviewButton.addEventListener('review-transaction-clicked', function() {
      console.log('Review Transaction button clicked');
      
      if (reviewModal) {
        throw new Error(`Review Transaction modal is already open`);
      } else {
        reviewModal = document.createElement('stellar-review-transaction-modal');
      }

      reviewModal.setAttribute('showModal', '');
      document.body.appendChild(reviewModal);

      const closeListener = (event) => {
        console.log('Modal closed');
        reviewModal.removeEventListener('modal-closed', closeListener, false);
        document.body.removeChild(reviewModal);
        reviewModal = undefined;
      };
      
      reviewModal.addEventListener('modal-closed', closeListener, false);
    });
  }

  createReviewTransactionButton();

  document.querySelector('#getAddress').addEventListener('click', async function(e) {
    const response = await kit.getAddress({ skipRequestAccess: true });
    document.querySelector('#publicKey').value = response.address;
    console.log({ response });
  })

  document.querySelector('#signButton').addEventListener('click', async function(e) {
    const inputElement = document.querySelector('#xdrTextArea');
    console.log('XDR to sign:', inputElement.value);

    const data = await kit.signTransaction(inputElement.value, {
      networkPassphrase: currentNetworkPassphrase,
      address: document.querySelector('#publicKey').value,
    });

    document.querySelector('#signedXdr').textContent = JSON.stringify(data, null, 2);
  })

  document.querySelector('#signMessageButton').addEventListener('click', async function(e) {
    const inputElement = document.querySelector('#signMessageTextArea');
    console.log('Message to sign:', inputElement.value);

    const data = await kit.signMessage(inputElement.value, {
      networkPassphrase: currentNetworkPassphrase,
      address: document.querySelector('#publicKey').value,
    });

    document.querySelector('#signedXdr').textContent = JSON.stringify(data, null, 2);
  })

  document.querySelector('#externalButton').addEventListener('click', function(e) {
    kit.openModal({
      onWalletSelected: onWalletSelected => {
        console.log({ onWalletSelected });
      },
      onClosed: onClosed => {
        console.error({ onClosed });
      },
      modalTitle: 'This is a different tittle',
      notAvailableText: 'Nope!'
    });
  });

  document.querySelector('#createButton').addEventListener('click', function(e) {
    createDefaultButton();
  });

  document.querySelector('#removeButton').addEventListener('click', function(e) {
    kit.removeButton();
  });

  kit.assignButtons({
    connectEl: '#externalConnect',
    disconnectEl: '#externalDisconnect',
    onConnect: ({ address }) => {
      console.log('Address requested: ', address);
      document.querySelector('#publicKey').setAttribute('value', address);
      
      // Show network selector when connected
      const networkSelector = document.querySelector('#networkSelectorWrapper');
      if (networkSelector) {
        networkSelector.style.display = 'block';
        setTimeout(() => {
          networkSelector.classList.add('show');
        }, 10);
      }
    },
    onDisconnect: () => {
      console.log('Disconnected from the button');
      
      // Hide network selector when disconnected
      const networkSelector = document.querySelector('#networkSelectorWrapper');
      if (networkSelector) {
        networkSelector.classList.remove('show');
        setTimeout(() => {
          networkSelector.style.display = 'none';
        }, 300);
      }
    },
  })
</script>
</body>
</html>
